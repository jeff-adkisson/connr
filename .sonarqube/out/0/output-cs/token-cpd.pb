†
1/Users/jeff/projects/connr/Connr.Process/Codes.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
class 
Codes 
{ 
public 

static 
readonly 
int 
Success &
=' (
$num) *
;* +
public 

static 
readonly 
int 
Error $
=% &
$num' (
;( )
} Ç
C/Users/jeff/projects/connr/Connr.Process/ConfigureProcessService.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
static 
class #
ConfigureProcessService +
{ 
public 

static 
void 
AddProcessService (
(( )
this) -
IServiceCollection. @
servicesA I
)I J
{ 
services		 
.		 
AddSingleton		 
<		 
IProcessService		 -
,		- .
ProcessService		/ =
>		= >
(		> ?
)		? @
;		@ A
}

 
} ±
8/Users/jeff/projects/connr/Connr.Process/EmptyProcess.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
class 
EmptyProcess 
: 
IProcessContainer -
,- .
IDisposable/ :
{ 
private 
EmptyProcess 
( 
) 
{ 
Result 
= 
Process 
. 
Result 
.  
Default  '
;' (

Statistics 
= 
new 

Statistics #
(# $
)$ %
;% &
Events		 
=		 
new		 
Events		 
(		 

Statistics		 &
)		& '
;		' (
}

 
public 

string 
Id 
=> 
$str 
;  
public 

void 
Start 
( 
) 
{ 
throw 
new !
NotSupportedException '
(' (
)( )
;) *
} 
public 

void 
Stop 
( 
) 
{ 
throw 
new !
NotSupportedException '
(' (
)( )
;) *
} 
public 

void 
Kill 
( 
) 
{ 
throw 
new !
NotSupportedException '
(' (
)( )
;) *
} 
public 


Parameters 

Parameters  
{! "
get# &
;& '
}( )
=* +
new, /
(/ 0
)0 1
;1 2
public 

Events 
Events 
{ 
get 
; 
}  !
private!! 
readonly!! 
IResult!! 
_result!! $
=!!% &
new!!' *
Result!!+ 1
(!!1 2
$num!!2 3
,!!3 4
new!!5 8

Statistics!!9 C
(!!C D
)!!D E
)!!E F
;!!F G
public## 

IResult## 
Result## 
{$$ 
get%% 
=>%% 
_result%% 
;%% 
set&& 
{'' 	
})) 	
}** 
public,, 

ProcessState,, 
State,, 
{,, 
get,,  #
;,,# $
},,% &
=,,' (
ProcessState,,) 5
.,,5 6

NotStarted,,6 @
;,,@ A
public.. 

Tokens.. 
Tokens.. 
{.. 
get.. 
;.. 
}..  !
=.." #
new..$ '
(..' (
new..( +

Parameters.., 6
(..6 7
)..7 8
)..8 9
;..9 :
public00 


Statistics00 

Statistics00  
{00! "
get00# &
;00& '
}00( )
public22 

static22 
EmptyProcess22 
Instance22 '
{22( )
get22* -
;22- .
}22/ 0
=221 2
new223 6
(226 7
)227 8
;228 9
public44 

void44 
Dispose44 
(44 
)44 
{55 
Events66 
.66 
Dispose66 
(66 
)66 
;66 
Tokens77 
.77 
Dispose77 
(77 
)77 
;77 
}88 
}99 ¤g
2/Users/jeff/projects/connr/Connr.Process/Events.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
sealed 
class 
Events 
: 
IDisposable (
{ 
private 
readonly 

Statistics 
_statistics  +
;+ ,
private

 
System

 
.

 
Timers

 
.

 
Timer

 
?

  
_timer

! '
;

' (
public 

Events 
( 

Statistics 

statistics '
)' (
{ 
_statistics 
= 

statistics  
;  !
} 
public 

event 
Action 
< 
IProcessContainer )
>) *
?* +
ProcessStarting, ;
;; <
public 

event 
Action 
< 
IProcessContainer )
>) *
?* +
ProcessRunning, :
;: ;
public 

event 
Action 
< 
IProcessContainer )
>) *
?* +
ProcessStopping, ;
;; <
public 

event 
Action 
< 
IProcessContainer )
>) *
?* +
ProcessKilling, :
;: ;
public 

event 
Action 
< 
IProcessContainer )
>) *
?* +
ProcessStopped, :
;: ;
public 

event 
Action 
< 
Line 
> 
? !
StandardOutputEmitted 4
;4 5
public 

event 
Action 
< 
Line 
> 
? 
ErrorOutputEmitted 1
;1 2
internal 
void  
RaiseProcessStarting &
(& '
IProcessContainer' 8
processContainer9 I
)I J
{   
ProcessStarting!! 
?!! 
.!! 
Invoke!! 
(!!  
processContainer!!  0
)!!0 1
;!!1 2
}"" 
internal$$ 
void$$ 
RaiseProcessRunning$$ %
($$% &
IProcessContainer$$& 7
processContainer$$8 H
)$$H I
{%% 
ProcessRunning&& 
?&& 
.&& 
Invoke&& 
(&& 
processContainer&& /
)&&/ 0
;&&0 1
}'' 
internal)) 
void))  
RaiseProcessStopping)) &
())& '
IProcessContainer))' 8
processContainer))9 I
)))I J
{** 
ProcessStopping++ 
?++ 
.++ 
Invoke++ 
(++  
processContainer++  0
)++0 1
;++1 2
},, 
internal.. 
void.. 
RaiseProcessKilling.. %
(..% &
IProcessContainer..& 7
processContainer..8 H
)..H I
{// 
ProcessKilling00 
?00 
.00 
Invoke00 
(00 
processContainer00 /
)00/ 0
;000 1
}11 
internal33 
void33 
RaiseProcessStopped33 %
(33% &
IProcessContainer33& 7
processContainer338 H
)33H I
{44 
ProcessStopped55 
?55 
.55 
Invoke55 
(55 
processContainer55 /
)55/ 0
;550 1
}66 
internal88 
void88 &
RaiseStandardOutputEmitted88 ,
(88, -
string88- 3
output884 :
)88: ;
{99 

StartTimer:: 
(:: 
):: 
;:: 
try;; 
{<< 	

_semaphore== 
.== 
Wait== 
(== 
)== 
;== 
_stdOutputAcc>> 
.>> 
Add>> 
(>> 
output>> $
)>>$ %
;>>% &
}?? 	
finally@@ 
{AA 	

_semaphoreBB 
.BB 
ReleaseBB 
(BB 
)BB  
;BB  !
}CC 	
}DD 
internalFF 
voidFF #
RaiseErrorOutputEmittedFF )
(FF) *
stringFF* 0
errorFF1 6
)FF6 7
{GG 

StartTimerHH 
(HH 
)HH 
;HH 
tryII 
{JJ 	

_semaphoreKK 
.KK 
WaitKK 
(KK 
)KK 
;KK 
_errorOutputAccLL 
.LL 
AddLL 
(LL  
errorLL  %
)LL% &
;LL& '
}MM 	
finallyNN 
{OO 	

_semaphorePP 
.PP 
ReleasePP 
(PP 
)PP  
;PP  !
}QQ 	
}RR 
privateTT 
voidTT 

StartTimerTT 
(TT 
)TT 
{UU 
ifVV 

(VV 
_timerVV 
!=VV 
nullVV 
)VV 
returnVV "
;VV" #
_timerWW 
=WW 
newWW 
(WW 
$numWW 
)WW 
{WW 
	AutoResetWW %
=WW& '
trueWW( ,
}WW- .
;WW. /
_timerXX 
.XX 
ElapsedXX 
+=XX 
FlushOutputXX %
;XX% &
_timerYY 
.YY 
StartYY 
(YY 
)YY 
;YY 
}ZZ 
private\\ 
readonly\\ 
SemaphoreSlim\\ "

_semaphore\\# -
=\\. /
new\\0 3
(\\3 4
$num\\4 5
,\\5 6
$num\\7 8
)\\8 9
;\\9 :
private]] 
void]] 
FlushOutput]] 
(]] 
object]] #
?]]# $
sender]]% +
,]]+ ,
ElapsedEventArgs]]- =
e]]> ?
)]]? @
{^^ 
string__ 
[__ 
]__ 
	stdOutput__ 
;__ 
string`` 
[`` 
]`` 
errorOutput`` 
;`` 
tryaa 
{bb 	

_semaphorecc 
.cc 
Waitcc 
(cc 
)cc 
;cc 
	stdOutputdd 
=dd 
_stdOutputAccdd %
.dd% &
ToArraydd& -
(dd- .
)dd. /
;dd/ 0
_stdOutputAccee 
.ee 
Clearee 
(ee  
)ee  !
;ee! "
errorOutputff 
=ff 
_errorOutputAccff )
.ff) *
ToArrayff* 1
(ff1 2
)ff2 3
;ff3 4
_errorOutputAccgg 
.gg 
Cleargg !
(gg! "
)gg" #
;gg# $
}hh 	
finallyii 
{jj 	

_semaphorekk 
.kk 
Releasekk 
(kk 
)kk  
;kk  !
}ll 	
foreachnn 
(nn 
varnn 
linenn 
innn 
GetLinesnn %
(nn% &
	stdOutputnn& /
)nn/ 0
)nn0 1
{oo 	
varpp 
newLinepp 
=pp 
_statisticspp %
.pp% &
AddToRecentLinespp& 6
(pp6 7
linepp7 ;
,pp; <
truepp= A
)ppA B
;ppB C!
StandardOutputEmittedqq !
?qq! "
.qq" #
Invokeqq# )
(qq) *
newLineqq* 1
)qq1 2
;qq2 3
}rr 	
foreachtt 
(tt 
vartt 
linett 
intt 
GetLinestt %
(tt% &
errorOutputtt& 1
)tt1 2
)tt2 3
{uu 	
varvv 
newLinevv 
=vv 
_statisticsvv %
.vv% &
AddToRecentLinesvv& 6
(vv6 7
linevv7 ;
,vv; <
falsevv= B
)vvB C
;vvC D
ErrorOutputEmittedww 
?ww 
.ww  
Invokeww  &
(ww& '
newLineww' .
)ww. /
;ww/ 0
}xx 	
}yy 
private{{ 
static{{ 
IEnumerable{{ 
<{{ 
string{{ %
>{{% &
GetLines{{' /
({{/ 0
string{{0 6
[{{6 7
]{{7 8
lines{{9 >
){{> ?
{|| 
if}} 

(}} 
lines}} 
.}} 
Length}} 
==}} 
$num}} 
)}} 
return}} %
lines}}& +
;}}+ ,
var 
	lineCount 
= 
$num 
; 
var
€€ 

recombined
€€ 
=
€€ 
new
€€ 
List
€€ !
<
€€! "
string
€€" (
>
€€( )
(
€€) *
)
€€* +
;
€€+ ,
void
‚‚  
FlushStringBuilder
‚‚ 
(
‚‚  
StringBuilder
‚‚  -
stringBuilder
‚‚. ;
,
‚‚; <
string
‚‚= C
nextLine
‚‚D L
)
‚‚L M
{
ƒƒ 	

recombined
„„ 
.
„„ 
Add
„„ 
(
„„ 
stringBuilder
„„ (
.
„„( )
ToString
„„) 1
(
„„1 2
)
„„2 3
)
„„3 4
;
„„4 5
stringBuilder
…… 
.
…… 
Clear
…… 
(
……  
)
……  !
;
……! "
stringBuilder
†† 
.
†† 

AppendLine
†† $
(
††$ %
nextLine
††% -
)
††- .
;
††. /
}
‡‡ 	
var
‰‰ 
sb
‰‰ 
=
‰‰ 
new
‰‰ 
StringBuilder
‰‰ "
(
‰‰" #
)
‰‰# $
;
‰‰$ %
sb
ŠŠ 

.
ŠŠ
 

AppendLine
ŠŠ 
(
ŠŠ 
lines
ŠŠ 
[
ŠŠ 
$num
ŠŠ 
]
ŠŠ 
)
ŠŠ 
;
ŠŠ  
foreach
‹‹ 
(
‹‹ 
var
‹‹ 
currentLine
‹‹  
in
‹‹! #
lines
‹‹$ )
[
‹‹) *
$num
‹‹* +
..
‹‹+ -
]
‹‹- .
)
‹‹. /
{
‹‹0 1
if
ŒŒ 
(
ŒŒ 
!
ŒŒ 
string
ŒŒ 
.
ŒŒ  
IsNullOrWhiteSpace
ŒŒ *
(
ŒŒ* +
currentLine
ŒŒ+ 6
)
ŒŒ6 7
&&
ŒŒ8 :
(
 
currentLine
 
.
 

StartsWith
 '
(
' (
$str
( ,
)
, -
||
. 0
currentLine
1 <
.
< =

StartsWith
= G
(
G H
$str
H L
)
L M
)
M N
)
N O
{
ŽŽ 
sb
 
.
 

AppendLine
 
(
 
currentLine
 )
)
) *
;
* +
if
 
(
 
	lineCount
 
>
 
$num
  !
)
! "
{
‘‘  
FlushStringBuilder
’’ &
(
’’& '
sb
’’' )
,
’’) *
currentLine
’’+ 6
)
’’6 7
;
’’7 8
	lineCount
““ 
=
““ 
$num
““  !
;
““! "
}
”” 
}
•• 
else
•• 
{
––  
FlushStringBuilder
—— "
(
——" #
sb
——# %
,
——% &
currentLine
——' 2
)
——2 3
;
——3 4
	lineCount
˜˜ 
=
˜˜ 
$num
˜˜ 
;
˜˜ 
}
™™ 
	lineCount
šš 
++
šš 
;
šš 
}
›› 	
if
œœ 

(
œœ 
sb
œœ 
.
œœ 
Length
œœ 
>
œœ 
$num
œœ 
)
œœ 

recombined
œœ %
.
œœ% &
Add
œœ& )
(
œœ) *
sb
œœ* ,
.
œœ, -
ToString
œœ- 5
(
œœ5 6
)
œœ6 7
)
œœ7 8
;
œœ8 9
return
žž 

recombined
žž 
.
žž 
ToArray
žž !
(
žž! "
)
žž" #
;
žž# $
}
ŸŸ 
private
¡¡ 
readonly
¡¡ 
List
¡¡ 
<
¡¡ 
string
¡¡  
>
¡¡  !
_stdOutputAcc
¡¡" /
=
¡¡0 1
new
¡¡2 5
(
¡¡5 6
)
¡¡6 7
;
¡¡7 8
private
¢¢ 
readonly
¢¢ 
List
¢¢ 
<
¢¢ 
string
¢¢  
>
¢¢  !
_errorOutputAcc
¢¢" 1
=
¢¢2 3
new
¢¢4 7
(
¢¢7 8
)
¢¢8 9
;
¢¢9 :
public
¤¤ 

void
¤¤ 
Dispose
¤¤ 
(
¤¤ 
)
¤¤ 
{
¥¥ 
_timer
¦¦ 
?
¦¦ 
.
¦¦ 
Stop
¦¦ 
(
¦¦ 
)
¦¦ 
;
¦¦ 
_timer
§§ 
?
§§ 
.
§§ 
Dispose
§§ 
(
§§ 
)
§§ 
;
§§ 
}
¨¨ 
}©© ¾

=/Users/jeff/projects/connr/Connr.Process/IProcessContainer.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
	interface 
IProcessContainer "
{ 
string 

Id 
{ 
get 
; 
} 

Parameters 

Parameters 
{ 
get 
;  
}! "
Events		 

Events		 
{		 
get		 
;		 
}		 
IResult

 
Result

 
{

 
get

 
;

 
set

 
;

 
}

  
ProcessState 
State 
{ 
get 
; 
} 
internal 
Tokens 
Tokens 
{ 
get  
;  !
}" #

Statistics 

Statistics 
{ 
get 
;  
}! "
public 

void 
Start 
( 
) 
; 
public 

void 
Stop 
( 
) 
; 
public 

void 
Kill 
( 
) 
; 
} Ñ
;/Users/jeff/projects/connr/Connr.Process/IProcessService.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
	interface 
IProcessService  
{ 
int "
RunningProcessingCount 
{  
get! $
;$ %
}& '
void 
Start	 
( 
IProcessContainer  
process! (
)( )
;) *
void 
StopAll	 
( 
bool 
waitUntilAllStopped )
=* +
true, 0
,0 1
int2 5
maxStopTimeSeconds6 H
=I J
$numK M
,M N
boolO S
killIfNotStoppedT d
=e f
trueg k
)k l
;l m
void

 
KillAll

	 
(

 
bool

 
waitUntilAllKilled

 (
=

) *
true

+ /
,

/ 0
int

1 4
maxStopTimeSeconds

5 G
=

H I
$num

J L
)

L M
;

M N
IReadOnlyList 
< 
IProcessContainer #
># $
GetRunningProcesses% 8
(8 9
)9 :
;: ;
bool 
TryGetProcesses	 
( 

Parameters #
parametersToMatch$ 5
,5 6
out7 :
List; ?
<? @
IProcessContainer@ Q
>Q R
runningProcessesS c
)c d
;d e
event 	
Action
 
< 
IProcessContainer "
>" #
ProcessStarted$ 2
;2 3
event 	
Action
 
< 
IProcessContainer "
>" #
ProcessEnded$ 0
;0 1
event 	
Action
 
< 
int 
> &
RunningProcessCountChanged 0
;0 1
} Ù
3/Users/jeff/projects/connr/Connr.Process/IResult.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
	interface 
IResult 
{ 
public 

int 
ExitCode 
{ 
get 
; 
}  
public 

DateTimeOffset 
	StartTime #
{$ %
get& )
;) *
}+ ,
public 

DateTimeOffset 
ExitTime "
{# $
get% (
;( )
}* +
public 

TimeSpan 
RunTime 
{ 
get !
;! "
}# $
public 

string 
Error 
{ 
get 
; 
}  
public!! 

bool!! 
Success!! 
{!! 
get!! 
;!! 
}!!  
}"" ä
0/Users/jeff/projects/connr/Connr.Process/Line.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
record 
Line 
{ 
public 

string 
Id 
{ 
get 
; 
} 
= 
System  &
.& '
Guid' +
.+ ,
NewGuid, 3
(3 4
)4 5
.5 6
ToString6 >
(> ?
)? @
;@ A
public 

long 
Number 
{ 
get 
; 
init "
;" #
}$ %
public		 

string		 
Output		 
{		 
get		 
;		 
init		  $
;		$ %
}		& '
=		( )
$str		* ,
;		, -
public 

bool 
IsStandardOutput  
{! "
get# &
;& '
init( ,
;, -
}. /
=0 1
true2 6
;6 7
} ‘	
;/Users/jeff/projects/connr/Connr.Process/OperatingSystem.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
static 
class 
OperatingSystem #
{ 
public		 

static		 
bool		 
	IsWindows		  
(		  !
)		! "
=>		# %
RuntimeInformation

 
.

 
IsOSPlatform

 '
(

' (

OSPlatform

( 2
.

2 3
Windows

3 :
)

: ;
;

; <
public 

static 
bool 
IsMacOS 
( 
)  
=>! #
RuntimeInformation 
. 
IsOSPlatform '
(' (

OSPlatform( 2
.2 3
OSX3 6
)6 7
;7 8
public 

static 
bool 
IsLinux 
( 
)  
=>! #
RuntimeInformation 
. 
IsOSPlatform '
(' (

OSPlatform( 2
.2 3
Linux3 8
)8 9
;9 :
} ƒ$
6/Users/jeff/projects/connr/Connr.Process/Parameters.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
sealed 
class 

Parameters 
:  

IEquatable! +
<+ ,

Parameters, 6
>6 7
{ 
public 

string 
Name 
{ 
get 
; 
init "
;" #
}$ %
=& '
$str( .
;. /
public		 

string		 
Command		 
{		 
get		 
;		  
init		! %
;		% &
}		' (
=		) *
$str		+ -
;		- .
public 

List 
< 
string 
> 
	Arguments !
{" #
get$ '
;' (
init) -
;- .
}/ 0
=1 2
new3 6
(6 7
)7 8
;8 9
public 

string 
WorkingDirectory "
{# $
get% (
;( )
init* .
;. /
}0 1
=2 3
$str4 6
;6 7
public 

bool 
	AutoStart 
{ 
get 
;  
init! %
;% &
}' (
=) *
false+ 0
;0 1
public 


Dictionary 
< 
string 
, 
string $
?$ %
>% & 
EnvironmentVariables' ;
{< =
get> A
;A B
initC G
;G H
}I J
=K L
newM P
(P Q
)Q R
;R S
public 

Credentials 
Credentials "
{# $
get% (
;( )
init* .
;. /
}0 1
=2 3
Credentials4 ?
.? @
Default@ G
;G H
public 

int 
StopAfterSeconds 
{  !
get" %
;% &
init' +
;+ ,
}- .
=/ 0
$num1 2
;2 3
public 

bool 
Equals 
( 

Parameters !
?! "
other# (
)( )
{ 
if 

( 
ReferenceEquals 
( 
null  
,  !
other" '
)' (
)( )
return* 0
false1 6
;6 7
if 

( 
ReferenceEquals 
( 
this  
,  !
other" '
)' (
)( )
return* 0
true1 5
;5 6
return 
Command 
== 
other 
.  
Command  '
&&( *
	Arguments 
. 
SequenceEqual &
(& '
other' ,
., -
	Arguments- 6
)6 7
&&8 :
WorkingDirectory 
==  "
other# (
.( )
WorkingDirectory) 9
&&: < 
EnvironmentVariables #
.# $
SequenceEqual$ 1
(1 2
other2 7
.7 8 
EnvironmentVariables8 L
)L M
&&N P
StopAfterSeconds 
==  "
other# (
.( )
StopAfterSeconds) 9
;9 :
}   
public"" 

override"" 
bool"" 
Equals"" 
(""  
object""  &
?""& '
obj""( +
)""+ ,
{## 
return$$ 
ReferenceEquals$$ 
($$ 
this$$ #
,$$# $
obj$$% (
)$$( )
||$$* ,
($$- .
obj$$. 1
is$$2 4

Parameters$$5 ?
other$$@ E
&&$$F H
Equals$$I O
($$O P
other$$P U
)$$U V
)$$V W
;$$W X
}%% 
public'' 

override'' 
int'' 
GetHashCode'' #
(''# $
)''$ %
{(( 
return)) 
HashCode)) 
.)) 
Combine)) 
())  
Command** 
,** 
	Arguments++ 
,++ 
WorkingDirectory,, 
,,,  
EnvironmentVariables--  
,--  !
StopAfterSeconds.. 
).. 
;.. 
}// 
}00 ´
</Users/jeff/projects/connr/Connr.Process/ProcessContainer.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
sealed 
class 
ProcessContainer $
:% &
IProcessContainer' 8
,8 9
IDisposable: E
{ 
public 

ProcessContainer 
( 

Parameters &

parameters' 1
)1 2
{ 
Id		 

=		 
Guid		 
.		 
NewGuid		 
(		 
)		 
.		 
ToString		 $
(		$ %
)		% &
;		& '

Parameters

 
=

 

parameters

 
;

  
Tokens 
= 
new 
Tokens 
( 

parameters &
)& '
;' (
StateMachine 
= 
new 
StateMachine '
(' (
this( ,
), -
;- .
Result 
= 
Process 
. 
Result 
.  
Default  '
;' (

Statistics 
= 
new 

Statistics #
(# $
)$ %
;% &
Events 
= 
new 
Events 
( 

Statistics &
)& '
;' (
} 
private 
StateMachine 
StateMachine %
{& '
get( +
;+ ,
}- .
public 

string 
Id 
{ 
get 
; 
} 
public 


Parameters 

Parameters  
{! "
get# &
;& '
}( )
public 

Events 
Events 
{ 
get 
; 
}  !
public 

IResult 
Result 
{ 
get 
;  
set! $
;$ %
}& '
public 

ProcessState 
State 
=>  
StateMachine! -
.- .
CurrentState. :
;: ;
public 

void 
Start 
( 
) 
{ 
StateMachine 
. 
TriggerStateChange '
(' (
ProcessTrigger( 6
.6 7
Start7 <
)< =
;= >
}   
public"" 

void"" 
Stop"" 
("" 
)"" 
{## 
StateMachine$$ 
.$$ 
TriggerStateChange$$ '
($$' (
ProcessTrigger$$( 6
.$$6 7
Stop$$7 ;
)$$; <
;$$< =
}%% 
public'' 

void'' 
Kill'' 
('' 
)'' 
{(( 
StateMachine)) 
.)) 
TriggerStateChange)) '
())' (
ProcessTrigger))( 6
.))6 7
Kill))7 ;
))); <
;))< =
}** 
public,, 

Tokens,, 
Tokens,, 
{,, 
get,, 
;,, 
},,  !
public.. 


Statistics.. 

Statistics..  
{..! "
get..# &
;..& '
}..( )
public00 

void00 
Dispose00 
(00 
)00 
{11 
Events22 
.22 
Dispose22 
(22 
)22 
;22 
Tokens33 
.33 
Dispose33 
(33 
)33 
;33 
}44 
}55 °E
5/Users/jeff/projects/connr/Connr.Process/Processes.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
class 
	Processes 
{ 
private 
readonly 
ILogger 
_logger $
;$ %
public

 

	Processes

 
(

 
ILogger

 
logger

 #
)

# $
{ 
_logger 
= 
logger 
; 
} 
private  
ConcurrentDictionary  
<  !
string! '
,' (
IProcessContainer) :
>: ;
RunningProcesses< L
{M N
getO R
;R S
}T U
=V W
newX [
([ \
)\ ]
;] ^
public 

int 
RunningProcessCount "
=># %
RunningProcesses& 6
.6 7
Count7 <
;< =
public 

void 
Start 
( 
IProcessContainer '
processContainer( 8
)8 9
{ 
processContainer 
. 
Events 
.  
ProcessRunning  .
+=/ 1"
AddToRunningDictionary2 H
;H I
processContainer 
. 
Events 
.  
ProcessStopped  .
+=/ 1'
RemoveFromRunningDictionary2 M
;M N
processContainer 
. 
Start 
( 
)  
;  !
} 
public 

void 
StopAll 
( 
bool 
waitUntilAllStopped 0
=1 2
true3 7
,7 8
int9 <
maxStopTimeSeconds= O
=P Q
$numR T
,T U
boolV Z
killIfNotStopped[ k
=l m
truen r
)r s
{ 
if 

( 
RunningProcesses 
. 
IsEmpty $
)$ %
return& ,
;, - 
CallStopAllProcesses 
( 
false "
)" #
;# $
var 
stopTryingAfter 
= 
DateTime &
.& '
Now' *
.* +

AddSeconds+ 5
(5 6
maxStopTimeSeconds6 H
)H I
;I J
if 

( 
waitUntilAllStopped 
)  
_logger   
.   
LogInformation   "
(  " #
$"  # %
$str  % 3
{  3 4
maxStopTimeSeconds  4 F
}  F G
$str  G i
"  i j
)  j k
;  k l
while!! 
(!! 
waitUntilAllStopped!! "
&&!!# %
DateTime!!& .
.!!. /
Now!!/ 2
<!!3 4
stopTryingAfter!!5 D
&&!!E G
!!!H I
RunningProcesses!!I Y
.!!Y Z
IsEmpty!!Z a
)!!a b
Task"" 
."" 
Delay"" 
("" 
$num"" 
)"" 
."" 
Wait""  
(""  !
)""! "
;""" #
if## 

(## 
waitUntilAllStopped## 
&&##  "
killIfNotStopped### 3
&&##4 6
!##7 8
RunningProcesses##8 H
.##H I
IsEmpty##I P
)##P Q
KillAll$$ 
($$ 
waitUntilAllStopped$$ '
,$$' (
maxStopTimeSeconds$$) ;
)$$; <
;$$< =
}%% 
public'' 

void'' 
KillAll'' 
('' 
bool'' 
waitUntilAllKilled'' /
=''0 1
true''2 6
,''6 7
int''8 ;
maxStopTimeSeconds''< N
=''O P
$num''Q S
)''S T
{(( 
if)) 

()) 
RunningProcesses)) 
.)) 
IsEmpty)) $
)))$ %
return))& ,
;)), - 
CallStopAllProcesses** 
(** 
true** !
)**! "
;**" #
var++ 
stopTryingAfter++ 
=++ 
DateTime++ &
.++& '
Now++' *
.++* +

AddSeconds+++ 5
(++5 6
maxStopTimeSeconds++6 H
)++H I
;++I J
if,, 

(,, 
waitUntilAllKilled,, 
),, 
_logger-- 
.-- 
LogInformation-- "
(--" #
$"--# %
$str--% 3
{--3 4
maxStopTimeSeconds--4 F
}--F G
$str--G s
"--s t
)--t u
;--u v
while.. 
(.. 
waitUntilAllKilled.. !
&&.." $
DateTime..% -
...- .
Now... 1
<..2 3
stopTryingAfter..4 C
&&..D F
!..G H
RunningProcesses..H X
...X Y
IsEmpty..Y `
)..` a
Task// 
.// 
Delay// 
(// 
$num// 
)// 
.// 
Wait//  
(//  !
)//! "
;//" #
}00 
private22 
void22  
CallStopAllProcesses22 %
(22% &
bool22& *
kill22+ /
)22/ 0
{33 
var44 
keys44 
=44 
RunningProcesses44 #
.44# $
Keys44$ (
;44( )
foreach55 
(55 
var55 
key55 
in55 
keys55  
)55  !
{66 	
if77 
(77 
!77 
RunningProcesses77 !
.77! "
TryGetValue77" -
(77- .
key77. 1
,771 2
out773 6
var777 :
process77; B
)77B C
)77C D
continue77E M
;77M N
if88 
(88 
kill88 
)88 
process99 
.99 
Kill99 
(99 
)99 
;99 
else:: 
process;; 
.;; 
Stop;; 
(;; 
);; 
;;; 
}<< 	
}== 
private?? 
void?? "
AddToRunningDictionary?? '
(??' (
IProcessContainer??( 9
processContainer??: J
)??J K
{@@ 
ifAA 

(AA 
!AA 
RunningProcessesAA 
.AA 
TryAddAA $
(AA$ %
processContainerAA% 5
.AA5 6
IdAA6 8
,AA8 9
processContainerAA: J
)AAJ K
)AAK L
returnAAM S
;AAS T
ProcessAddedCC 
?CC 
.CC 
InvokeCC 
(CC 
processContainerCC -
)CC- .
;CC. /
processContainerDD 
.DD 
EventsDD 
.DD  
ProcessRunningDD  .
-=DD/ 1"
AddToRunningDictionaryDD2 H
;DDH I
}EE 
privateGG 
voidGG '
RemoveFromRunningDictionaryGG ,
(GG, -
IProcessContainerGG- >
processContainerGG? O
)GGO P
{HH 
ifII 

(II 
!II 
RunningProcessesII 
.II 
	TryRemoveII '
(II' (
processContainerII( 8
.II8 9
IdII9 ;
,II; <
outII= @
varIIA D#
removedProcessContainerIIE \
)II\ ]
)II] ^
returnII_ e
;IIe f
ProcessRemovedKK 
?KK 
.KK 
InvokeKK 
(KK #
removedProcessContainerKK 6
)KK6 7
;KK7 8#
removedProcessContainerLL 
.LL  
EventsLL  &
.LL& '
ProcessStoppedLL' 5
-=LL6 8'
RemoveFromRunningDictionaryLL9 T
;LLT U
}MM 
publicOO 

eventOO 
ActionOO 
<OO 
IProcessContainerOO )
>OO) *
?OO* +
ProcessAddedOO, 8
;OO8 9
publicQQ 

eventQQ 
ActionQQ 
<QQ 
IProcessContainerQQ )
>QQ) *
?QQ* +
ProcessRemovedQQ, :
;QQ: ;
publicSS 

IReadOnlyListSS 
<SS 
IProcessContainerSS *
>SS* +
GetRunningProcessesSS, ?
(SS? @
)SS@ A
{TT 
returnUU 
RunningProcessesUU 
.VV 
SelectVV 
(VV 
pVV 
=>VV 
pVV 
.VV 
ValueVV  
)VV  !
.WW 
ToListWW 
(WW 
)WW 
.XX 

AsReadOnlyXX 
(XX 
)XX 
;XX 
}YY 
}ZZ ä.
:/Users/jeff/projects/connr/Connr.Process/ProcessService.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
class 
ProcessService 
: 
IProcessService -
{ 
private 
readonly 
ILogger 
< 
ProcessService +
>+ ,
_logger- 4
;4 5
public		 

ProcessService		 
(		 
ILogger		 !
<		! "
ProcessService		" 0
>		0 1
logger		2 8
)		8 9
{

 
_logger 
= 
logger 
; 
	Processes 
= 
new 
	Processes !
(! "
_logger" )
)) *
;* +
	Processes 
. 
ProcessAdded 
+= !
ProcessAdded" .
;. /
	Processes 
. 
ProcessRemoved  
+=! #
ProcessRemoved$ 2
;2 3
} 
private 
	Processes 
	Processes 
{  !
get" %
;% &
}' (
public 

void 
Start 
( 
IProcessContainer '
process( /
)/ 0
{ 
	Processes 
. 
Start 
( 
process 
)  
;  !
} 
public 

void 
StopAll 
( 
bool 
waitUntilAllStopped 0
=1 2
true3 7
,7 8
int9 <
maxStopTimeSeconds= O
=P Q
$numR T
,T U
boolV Z
killIfNotStopped[ k
=l m
truen r
)r s
{ 
	Processes 
. 
StopAll 
( 
waitUntilAllStopped -
,- .
maxStopTimeSeconds/ A
,A B
killIfNotStoppedC S
)S T
;T U
} 
public 

void 
KillAll 
( 
bool 
waitUntilAllKilled /
=0 1
true2 6
,6 7
int8 ;
maxStopTimeSeconds< N
=O P
$numQ S
)S T
{ 
	Processes 
. 
KillAll 
( 
waitUntilAllKilled ,
,, -
maxStopTimeSeconds. @
)@ A
;A B
}   
public"" 

IReadOnlyList"" 
<"" 
IProcessContainer"" *
>""* +
GetRunningProcesses"", ?
(""? @
)""@ A
{## 
return$$ 
	Processes$$ 
.$$ 
GetRunningProcesses$$ ,
($$, -
)$$- .
;$$. /
}%% 
public.. 

bool.. 
TryGetProcesses.. 
(..  

Parameters..  *
parametersToMatch..+ <
,..< =
out..> A
List..B F
<..F G
IProcessContainer..G X
>..X Y
runningProcesses..Z j
)..j k
{// 
runningProcesses00 
=00 
new00 
List00 #
<00# $
IProcessContainer00$ 5
>005 6
(006 7
)007 8
;008 9
var11 
currentProcesses11 
=11 
GetRunningProcesses11 2
(112 3
)113 4
;114 5
foreach22 
(22 
var22 
runningProcess22 #
in22$ &
currentProcesses22' 7
)227 8
{33 	
if44 
(44 
runningProcess44 
.44 

Parameters44 )
.44) *
Equals44* 0
(440 1
parametersToMatch441 B
)44B C
)44C D
{55 
runningProcesses66  
.66  !
Add66! $
(66$ %
runningProcess66% 3
)663 4
;664 5
}77 
}88 	
return99 
runningProcesses99 
.99  
Any99  #
(99# $
)99$ %
;99% &
}:: 
public<< 

int<< "
RunningProcessingCount<< %
=><<& (
	Processes<<) 2
.<<2 3
RunningProcessCount<<3 F
;<<F G
public>> 

event>> 
Action>> 
<>> 
IProcessContainer>> )
>>>) *
?>>* +
ProcessStarted>>, :
;>>: ;
public@@ 

event@@ 
Action@@ 
<@@ 
IProcessContainer@@ )
>@@) *
?@@* +
ProcessEnded@@, 8
;@@8 9
publicBB 

eventBB 
ActionBB 
<BB 
intBB 
>BB 
?BB &
RunningProcessCountChangedBB 8
;BB8 9
privateDD 
voidDD 
ProcessRemovedDD 
(DD  
IProcessContainerDD  1
processDD2 9
)DD9 :
{EE 
ProcessEndedFF 
?FF 
.FF 
InvokeFF 
(FF 
processFF $
)FF$ %
;FF% &&
RunningProcessCountChangedGG "
?GG" #
.GG# $
InvokeGG$ *
(GG* +"
RunningProcessingCountGG+ A
)GGA B
;GGB C
}HH 
privateJJ 
voidJJ 
ProcessAddedJJ 
(JJ 
IProcessContainerJJ /
processJJ0 7
)JJ7 8
{KK 
ProcessStartedLL 
?LL 
.LL 
InvokeLL 
(LL 
processLL &
)LL& '
;LL' (&
RunningProcessCountChangedMM "
?MM" #
.MM# $
InvokeMM$ *
(MM* +"
RunningProcessingCountMM+ A
)MMA B
;MMB C
}NN 
}OO ‰
8/Users/jeff/projects/connr/Connr.Process/ProcessState.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
enum 
ProcessState 
{ 

NotStarted 
, 
Starting 
, 
Running		 
,		 
Stopping

 
,

 
Killing 
, 
Ended 	
,	 

EndedSuccess 
, 

EndedError 
}  "
B/Users/jeff/projects/connr/Connr.Process/ProcessStateExtensions.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
static 
class "
ProcessStateExtensions *
{ 
public 

static 
bool 
CanStart 
(  
this  $
ProcessState% 1
state2 7
)7 8
{ 
return 
state 
is 
ProcessState $
.$ %

NotStarted% /
||0 2
state3 8
.8 9
IsEnded9 @
(@ A
)A B
;B C
} 
public

 

static

 
bool

 
CanStop

 
(

 
this

 #
ProcessState

$ 0
state

1 6
)

6 7
{ 
return 
state 
is 
ProcessState $
.$ %
Starting% -
or. 0
ProcessState1 =
.= >
Running> E
;E F
} 
public 

static 
bool 
CanKill 
( 
this #
ProcessState$ 0
state1 6
)6 7
{ 
return 
state 
. 
CanStop 
( 
) 
|| !

IsStopping" ,
(, -
state- 2
)2 3
;3 4
} 
public 

static 
bool 
IsNotStarted #
(# $
this$ (
ProcessState) 5
state6 ;
); <
{ 
return 
state 
is 
ProcessState $
.$ %

NotStarted% /
;/ 0
} 
public 

static 
bool 

IsStarting !
(! "
this" &
ProcessState' 3
state4 9
)9 :
{ 
return 
state 
is 
ProcessState $
.$ %
Starting% -
;- .
} 
public 

static 
bool 
	IsRunning  
(  !
this! %
ProcessState& 2
state3 8
)8 9
{ 
return   
state   
is   
ProcessState   $
.  $ %
Running  % ,
or  - /
ProcessState  0 <
.  < =
Stopping  = E
or  F H
ProcessState  I U
.  U V
Killing  V ]
;  ] ^
}!! 
public## 

static## 
bool## 

IsStopping## !
(##! "
this##" &
ProcessState##' 3
state##4 9
)##9 :
{$$ 
return%% 
state%% 
is%% 
ProcessState%% $
.%%$ %
Stopping%%% -
or%%. 0
ProcessState%%1 =
.%%= >
Killing%%> E
;%%E F
}&& 
public(( 

static(( 
bool(( 
	IsStopped((  
(((  !
this((! %
ProcessState((& 2
state((3 8
)((8 9
{)) 
return** 
state** 
is** 
ProcessState** $
.**$ %
EndedSuccess**% 1
or**2 4
ProcessState**5 A
.**A B

EndedError**B L
;**L M
}++ 
public-- 

static-- 
bool-- 
	IsKilling--  
(--  !
this--! %
ProcessState--& 2
state--3 8
)--8 9
{.. 
return// 
state// 
is// 
ProcessState// $
.//$ %
Killing//% ,
;//, -
}00 
public22 

static22 
bool22 
IsEnded22 
(22 
this22 #
ProcessState22$ 0
state221 6
)226 7
{33 
return44 
state44 
is44 
ProcessState44 $
.44$ %
Ended44% *
or44+ -
ProcessState44. :
.44: ;
EndedSuccess44; G
or44H J
ProcessState44K W
.44W X

EndedError44X b
;44b c
}55 
}66 º
:/Users/jeff/projects/connr/Connr.Process/ProcessTrigger.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
enum 
ProcessTrigger 
{ 
Start 	
,	 

Run 
, 
Stop 
, 	
Kill 
, 	
EndWithSuccess		 
,		 
EndWithError

 
} Ñ
2/Users/jeff/projects/connr/Connr.Process/Result.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
class 
Result 
: 
CommandResult #
,# $
IResult% ,
{ 
public 

Result 
( 
int 
exitCode 
, 

Statistics		 

statistics		 
)		 
:		  
base

 
(

 
exitCode 
, 

statistics 
. 
	StartedAt  
,  !

statistics 
. 
	StoppedAt  
)  !
{ 
} 
public 

static 
IResult 
Default !
{" #
get$ '
;' (
}) *
=+ ,
new- 0
Result1 7
(7 8
-8 9
$num9 :
,: ;
new< ?

Statistics@ J
(J K
)K L
)L M
;M N
public 

string 
Error 
{ 
get 
; 
set "
;" #
}$ %
=& '
$str( *
;* +
public 

bool 
Success 
=> 
ExitCode #
==$ &
Codes' ,
., -
Success- 4
;4 5
} Œ
8/Users/jeff/projects/connr/Connr.Process/StateMachine.cs
	namespace 	
Connr
 
. 
Process 
; 
public

 
class

 
StateMachine

 
{ 
private 
readonly 
ProcessContainer %

_container& 0
;0 1
public 

StateMachine 
( 
ProcessContainer (
	container) 2
)2 3
{ 

_container 
= 
	container 
; 
State 
= 
new 
StateMachine  
<  !
ProcessState! -
,- .
ProcessTrigger/ =
>= >
(> ?
( 
) 
=> 
CurrentState 
, 
newState 
=> 
CurrentState $
=% &
newState' /
)/ 0
;0 1
ConfigureMachine 
( 
) 
; 
} 
private 
Tokens 
Tokens 
=> 

_container '
.' (
Tokens( .
;. /
private 

Parameters 

Parameters !
=>" $

_container% /
./ 0

Parameters0 :
;: ;
private 

Statistics 

Statistics !
=>" $

_container% /
./ 0

Statistics0 :
;: ;
public 

ProcessState 
CurrentState $
{% &
get' *
;* +
private, 3
set4 7
;7 8
}9 :
=; <
ProcessState= I
.I J

NotStartedJ T
;T U
private   
Events   
Events   
=>   

_container   '
.  ' (
Events  ( .
;  . /
private"" 
IResult"" 
Result"" 
{## 
get$$ 
=>$$ 

_container$$ 
.$$ 
Result$$  
;$$  !
set%% 
=>%% 

_container%% 
.%% 
Result%%  
=%%! "
value%%# (
;%%( )
}&& 
private(( 
StateMachine(( 
<(( 
ProcessState(( %
,((% &
ProcessTrigger((' 5
>((5 6
State((7 <
{((= >
get((? B
;((B C
}((D E
private** 
void** 
ConfigureMachine** !
(**! "
)**" #
{++ 
State,, 
.,, 
	Configure,, 
(,, 
ProcessState,, $
.,,$ %

NotStarted,,% /
),,/ 0
.-- 
Permit-- 
(-- 
ProcessTrigger-- "
.--" #
Start--# (
,--( )
ProcessState--* 6
.--6 7
Starting--7 ?
)--? @
;--@ A
State// 
.// 
	Configure// 
(// 
ProcessState// $
.//$ %
Starting//% -
)//- .
.00 
Permit00 
(00 
ProcessTrigger00 "
.00" #
Run00# &
,00& '
ProcessState00( 4
.004 5
Running005 <
)00< =
.11 
Permit11 
(11 
ProcessTrigger11 "
.11" #
EndWithError11# /
,11/ 0
ProcessState111 =
.11= >

EndedError11> H
)11H I
.22 
OnEntry22 
(22 
Start22 
)22 
;22 
State44 
.44 
	Configure44 
(44 
ProcessState44 $
.44$ %
Running44% ,
)44, -
.55 
Permit55 
(55 
ProcessTrigger55 "
.55" #
EndWithSuccess55# 1
,551 2
ProcessState553 ?
.55? @
EndedSuccess55@ L
)55L M
.66 
Permit66 
(66 
ProcessTrigger66 "
.66" #
EndWithError66# /
,66/ 0
ProcessState661 =
.66= >

EndedError66> H
)66H I
.77 
Permit77 
(77 
ProcessTrigger77 "
.77" #
Stop77# '
,77' (
ProcessState77) 5
.775 6
Stopping776 >
)77> ?
.88 
Permit88 
(88 
ProcessTrigger88 "
.88" #
Kill88# '
,88' (
ProcessState88) 5
.885 6
Killing886 =
)88= >
;88> ?
State:: 
.:: 
	Configure:: 
(:: 
ProcessState:: $
.::$ %
Stopping::% -
)::- .
.;; 
Permit;; 
(;; 
ProcessTrigger;; "
.;;" #
Kill;;# '
,;;' (
ProcessState;;) 5
.;;5 6
Killing;;6 =
);;= >
.<< 
Permit<< 
(<< 
ProcessTrigger<< "
.<<" #
EndWithSuccess<<# 1
,<<1 2
ProcessState<<3 ?
.<<? @
EndedSuccess<<@ L
)<<L M
.== 
Permit== 
(== 
ProcessTrigger== "
.==" #
EndWithError==# /
,==/ 0
ProcessState==1 =
.=== >

EndedError==> H
)==H I
.>> 
OnEntry>> 
(>> 
Stop>> 
)>> 
;>> 
State@@ 
.@@ 
	Configure@@ 
(@@ 
ProcessState@@ $
.@@$ %
Killing@@% ,
)@@, -
.AA 
PermitAA 
(AA 
ProcessTriggerAA "
.AA" #
EndWithSuccessAA# 1
,AA1 2
ProcessStateAA3 ?
.AA? @
EndedSuccessAA@ L
)AAL M
.BB 
PermitBB 
(BB 
ProcessTriggerBB "
.BB" #
EndWithErrorBB# /
,BB/ 0
ProcessStateBB1 =
.BB= >

EndedErrorBB> H
)BBH I
.CC 
OnEntryCC 
(CC 
KillCC 
)CC 
;CC 
StateEE 
.EE 
	ConfigureEE 
(EE 
ProcessStateEE $
.EE$ %
EndedSuccessEE% 1
)EE1 2
.FF 

SubstateOfFF 
(FF 
ProcessStateFF $
.FF$ %
EndedFF% *
)FF* +
;FF+ ,
StateHH 
.HH 
	ConfigureHH 
(HH 
ProcessStateHH $
.HH$ %

EndedErrorHH% /
)HH/ 0
.II 

SubstateOfII 
(II 
ProcessStateII $
.II$ %
EndedII% *
)II* +
.JJ 
OnEntryJJ 
(JJ 
OnEndedErrorJJ !
)JJ! "
;JJ" #
varLL 
vizLL 
=LL 
UmlDotGraphLL 
.LL 
FormatLL $
(LL$ %
StateLL% *
.LL* +
GetInfoLL+ 2
(LL2 3
)LL3 4
)LL4 5
;LL5 6
}MM 
privateOO 
voidOO 
StopOO 
(OO 
)OO 
{PP 
EventsQQ 
.QQ  
RaiseProcessStoppingQQ #
(QQ# $

_containerQQ$ .
)QQ. /
;QQ/ 0
TokensRR 
.RR 
StopTokenSourceRR 
.RR 
CancelRR %
(RR% &
)RR& '
;RR' (
ifTT 

(TT 
OperatingSystemTT 
.TT 
	IsWindowsTT %
(TT% &
)TT& '
)TT' (
returnTT) /
;TT/ 0$
IssueFriendlyKillRequestUU  
(UU  !
)UU! "
;UU" #
}VV 
privateZZ 
voidZZ $
IssueFriendlyKillRequestZZ )
(ZZ) *
)ZZ* +
{[[ 
var\\ 
killArgs\\ 
=\\ 
$"\\ 
$str\\ !
{\\! "

_container\\" ,
.\\, -

Statistics\\- 7
.\\7 8
	ProcessId\\8 A
}\\A B
"\\B C
;\\C D
Console]] 
.]] 
	WriteLine]] 
(]] 
$"]] 
$str]] @
{]]@ A
killArgs]]A I
}]]I J
"]]J K
)]]K L
;]]L M
Task^^ 
.^^ 
Run^^ 
(^^ 
async^^ 
(^^ 
)^^ 
=>^^ 
{__ 	
var`` 
result`` 
=`` 
await`` 
Cli`` "
.``" #
Wrap``# '
(``' (
$str``( .
)``. /
.aa 
WithArgumentsaa 
(aa 
killArgsaa '
)aa' (
.bb 
ExecuteAsyncbb 
(bb 
)bb 
;bb  
}cc 	
)cc	 

.cc
 
ConfigureAwaitcc 
(cc 
falsecc 
)cc  
;cc  !
}dd 
privateff 
voidff 
Killff 
(ff 
)ff 
{gg 
Eventshh 
.hh 
RaiseProcessKillinghh "
(hh" #

_containerhh# -
)hh- .
;hh. /
Tokensii 
.ii 
KillTokenSourceii 
.ii 
Cancelii %
(ii% &
)ii& '
;ii' (
}jj 
privatell 
voidll 
Startll 
(ll 
)ll 
{mm 
Tasknn 
.nn 
Runnn 
(nn 
asyncnn 
(nn 
)nn 
=>nn 
{oo 	
trypp 
{qq 
Eventsrr 
.rr  
RaiseProcessStartingrr +
(rr+ ,

_containerrr, 6
)rr6 7
;rr7 8
varss 
cmdss 
=ss 
Cliss 
.ss 
Wrapss "
(ss" #

Parametersss# -
.ss- .
Commandss. 5
!ss5 6
)ss6 7
.tt 
WithArgumentstt "
(tt" #

Parameterstt# -
.tt- .
	Argumentstt. 7
)tt7 8
.uu $
WithEnvironmentVariablesuu -
(uu- .

Parametersuu. 8
.uu8 9 
EnvironmentVariablesuu9 M
)uuM N
.vv  
WithWorkingDirectoryvv )
(vv) *

Parametersvv* 4
.vv4 5
WorkingDirectoryvv5 E
)vvE F
.ww 
WithCredentialsww $
(ww$ %

Parametersww% /
.ww/ 0
Credentialsww0 ;
)ww; <
;ww< =
awaityy 
cmdyy 
.yy 
Observeyy !
(yy! "
Consolezz 
.zz  
OutputEncodingzz  .
,zz. /
Console{{ 
.{{  
OutputEncoding{{  .
,{{. /
Tokens|| 
.|| 
KillTokenSource|| .
.||. /
Token||/ 4
,||4 5
Tokens}} 
.}} 
StopTokenSource}} .
.}}. /
Token}}/ 4
)}}4 5
.~~ 
ForEachAsync~~ !
(~~! "
HandleProcessEvent~~" 4
)~~4 5
;~~5 6
} 
catch
€€ 
(
€€ #
TaskCanceledException
€€ (
taskEx
€€) /
)
€€/ 0
{
 

Statistics
‚‚ 
.
‚‚ 
	StoppedAt
‚‚ $
=
‚‚% &
DateTime
‚‚' /
.
‚‚/ 0
Now
‚‚0 3
;
‚‚3 4
var
ƒƒ 
code
ƒƒ 
=
ƒƒ 
Tokens
ƒƒ !
.
ƒƒ! "
StopTokenSource
ƒƒ" 1
.
ƒƒ1 2%
IsCancellationRequested
ƒƒ2 I
&&
ƒƒJ L
!
„„ 
Tokens
„„ "
.
„„" #
KillTokenSource
„„# 2
.
„„2 3%
IsCancellationRequested
„„3 J
?
…… 
Codes
…… 
.
…… 
Success
…… #
:
†† 
Codes
†† 
.
†† 
Error
†† !
;
††! "
var
‡‡ 
errorMsg
‡‡ 
=
‡‡ 
code
‡‡ #
==
‡‡$ &
Codes
‡‡' ,
.
‡‡, -
Success
‡‡- 4
?
‡‡5 6
$str
‡‡7 9
:
‡‡: ;
taskEx
‡‡< B
.
‡‡B C
Message
‡‡C J
;
‡‡J K
Result
ˆˆ 
=
ˆˆ 
new
ˆˆ 
Result
ˆˆ #
(
ˆˆ# $
code
ˆˆ$ (
,
ˆˆ( )

Statistics
ˆˆ* 4
)
ˆˆ4 5
{
ˆˆ6 7
Error
ˆˆ8 =
=
ˆˆ> ?
errorMsg
ˆˆ@ H
}
ˆˆI J
;
ˆˆJ K 
HandleProcessEvent
‰‰ "
(
‰‰" #
new
ŠŠ  
ExitedCommandEvent
ŠŠ *
(
ŠŠ* +
code
ŠŠ+ /
)
ŠŠ/ 0
)
ŠŠ0 1
;
ŠŠ1 2
await
‹‹ 
State
‹‹ 
.
‹‹ 
	FireAsync
‹‹ %
(
‹‹% &
code
‹‹& *
==
‹‹+ -
Codes
‹‹. 3
.
‹‹3 4
Success
‹‹4 ;
?
ŒŒ 
ProcessTrigger
ŒŒ $
.
ŒŒ$ %
EndWithSuccess
ŒŒ% 3
:
 
ProcessTrigger
 $
.
$ %
EndWithError
% 1
)
1 2
;
2 3
}
ŽŽ 
catch
 
(
 
	Exception
 
ex
 
)
  
{
 

Statistics
‘‘ 
.
‘‘ 
	StoppedAt
‘‘ $
=
‘‘% &
DateTime
‘‘' /
.
‘‘/ 0
Now
‘‘0 3
;
‘‘3 4
Result
’’ 
=
’’ 
new
’’ 
Result
’’ #
(
’’# $
Codes
’’$ )
.
’’) *
Error
’’* /
,
’’/ 0

Statistics
’’1 ;
)
’’; <
{
’’= >
Error
’’? D
=
’’E F
ex
’’G I
.
’’I J
Message
’’J Q
}
’’R S
;
’’S T
await
““ 
State
““ 
.
““ 
	FireAsync
““ %
(
““% &
ProcessTrigger
““& 4
.
““4 5
EndWithError
““5 A
)
““A B
;
““B C
}
”” 
}
•• 	
)
••	 

.
••
 
ConfigureAwait
•• 
(
•• 
false
•• 
)
••  
;
••  !
}
–– 
private
˜˜ 
async
˜˜ 
void
˜˜  
HandleProcessEvent
˜˜ )
(
˜˜) *
CommandEvent
˜˜* 6
evt
˜˜7 :
)
˜˜: ;
{
™™ 
switch
šš 
(
šš 
evt
šš 
)
šš 
{
›› 	
case
œœ !
StartedCommandEvent
œœ $!
startedCommandEvent
œœ% 8
:
œœ8 9
	OnStarted
 
(
 !
startedCommandEvent
 -
)
- .
;
. /
break
žž 
;
žž 
case
    
ExitedCommandEvent
   # 
exitedCommandEvent
  $ 6
:
  6 7
await
¡¡ 
OnExited
¡¡ 
(
¡¡  
exitedCommandEvent
¡¡ 1
)
¡¡1 2
;
¡¡2 3
break
¢¢ 
;
¢¢ 
case
¤¤ '
StandardErrorCommandEvent
¤¤ *'
standardErrorCommandEvent
¤¤+ D
:
¤¤D E
OnStandardError
¥¥ 
(
¥¥  '
standardErrorCommandEvent
¥¥  9
)
¥¥9 :
;
¥¥: ;
break
¦¦ 
;
¦¦ 
case
¨¨ (
StandardOutputCommandEvent
¨¨ +(
standardOutputCommandEvent
¨¨, F
:
¨¨F G
OnStandardOutput
©©  
(
©©  !(
standardOutputCommandEvent
©©! ;
)
©©; <
;
©©< =
break
ªª 
;
ªª 
default
¬¬ 
:
¬¬ 
throw
­­ 
new
­­ )
ArgumentOutOfRangeException
­­ 5
(
­­5 6
nameof
­­6 <
(
­­< =
evt
­­= @
)
­­@ A
)
­­A B
;
­­B C
}
®® 	
}
¯¯ 
private
±± 
readonly
±± 
SemaphoreSlim
±± "

_semaphore
±±# -
=
±±. /
new
±±0 3
SemaphoreSlim
±±4 A
(
±±A B
$num
±±B C
,
±±C D
$num
±±E F
)
±±F G
;
±±G H
private
³³ 
void
³³ 
OnStandardError
³³  
(
³³  !'
StandardErrorCommandEvent
³³! :
evt
³³; >
)
³³> ?
{
´´ 
Events
µµ 
.
µµ %
RaiseErrorOutputEmitted
µµ &
(
µµ& '
evt
µµ' *
.
µµ* +
Text
µµ+ /
)
µµ/ 0
;
µµ0 1
}
¶¶ 
private
¸¸ 
void
¸¸ 
OnStandardOutput
¸¸ !
(
¸¸! "(
StandardOutputCommandEvent
¸¸" <
evt
¸¸= @
)
¸¸@ A
{
¹¹ 
Events
ºº 
.
ºº (
RaiseStandardOutputEmitted
ºº )
(
ºº) *
evt
ºº* -
.
ºº- .
Text
ºº. 2
)
ºº2 3
;
ºº3 4
}
»» 
private
½½ 
void
½½ 
	OnStarted
½½ 
(
½½ !
StartedCommandEvent
½½ .!
startedCommandEvent
½½/ B
)
½½B C
{
¾¾ 

Statistics
¿¿ 
.
¿¿ 
	StartedAt
¿¿ 
=
¿¿ 
DateTime
¿¿ '
.
¿¿' (
Now
¿¿( +
;
¿¿+ ,

Statistics
ÀÀ 
.
ÀÀ 
	ProcessId
ÀÀ 
=
ÀÀ !
startedCommandEvent
ÀÀ 2
.
ÀÀ2 3
	ProcessId
ÀÀ3 <
;
ÀÀ< =
State
ÁÁ 
.
ÁÁ 
Fire
ÁÁ 
(
ÁÁ 
ProcessTrigger
ÁÁ !
.
ÁÁ! "
Run
ÁÁ" %
)
ÁÁ% &
;
ÁÁ& '
Events
ÂÂ 
.
ÂÂ !
RaiseProcessRunning
ÂÂ "
(
ÂÂ" #

_container
ÂÂ# -
)
ÂÂ- .
;
ÂÂ. /
}
ÃÃ 
private
ÅÅ 
async
ÅÅ 
Task
ÅÅ 
OnExited
ÅÅ 
(
ÅÅ   
ExitedCommandEvent
ÅÅ  2 
exitedCommandEvent
ÅÅ3 E
)
ÅÅE F
{
ÆÆ 
Result
ÇÇ 
=
ÇÇ 
new
ÇÇ 
Result
ÇÇ 
(
ÇÇ  
exitedCommandEvent
ÇÇ .
.
ÇÇ. /
ExitCode
ÇÇ/ 7
,
ÇÇ7 8

Statistics
ÇÇ9 C
)
ÇÇC D
;
ÇÇD E
await
ÈÈ 
State
ÈÈ 
.
ÈÈ 
	FireAsync
ÈÈ 
(
ÈÈ 
Result
ÉÉ 
.
ÉÉ 
Success
ÉÉ 
?
ÊÊ 
ProcessTrigger
ÊÊ  
.
ÊÊ  !
EndWithSuccess
ÊÊ! /
:
ËË 
ProcessTrigger
ËË  
.
ËË  !
EndWithError
ËË! -
)
ËË- .
;
ËË. /
OnEnded
ÌÌ 
(
ÌÌ 
)
ÌÌ 
;
ÌÌ 
}
ÍÍ 
private
ÏÏ 
void
ÏÏ 
OnEndedError
ÏÏ 
(
ÏÏ 
)
ÏÏ 
{
ÐÐ 
OnStandardError
ÑÑ 
(
ÑÑ 
new
ÑÑ '
StandardErrorCommandEvent
ÑÑ 5
(
ÑÑ5 6
Result
ÑÑ6 <
.
ÑÑ< =
Error
ÑÑ= B
)
ÑÑB C
)
ÑÑC D
;
ÑÑD E
OnEnded
ÒÒ 
(
ÒÒ 
)
ÒÒ 
;
ÒÒ 
}
ÓÓ 
private
ÕÕ 
void
ÕÕ 
OnEnded
ÕÕ 
(
ÕÕ 
)
ÕÕ 
{
ÖÖ 

Statistics
×× 
.
×× 
	StoppedAt
×× 
=
×× 
DateTime
×× '
.
××' (
Now
××( +
;
××+ ,
Events
ØØ 
.
ØØ !
RaiseProcessStopped
ØØ "
(
ØØ" #

_container
ØØ# -
)
ØØ- .
;
ØØ. /
}
ÙÙ 
internal
ÜÜ 
void
ÜÜ  
TriggerStateChange
ÜÜ $
(
ÜÜ$ %
ProcessTrigger
ÜÜ% 3
trigger
ÜÜ4 ;
)
ÜÜ; <
{
ÝÝ 
State
ÞÞ 
.
ÞÞ 
Fire
ÞÞ 
(
ÞÞ 
trigger
ÞÞ 
)
ÞÞ 
;
ÞÞ 
}
ßß 
}àà ²$
6/Users/jeff/projects/connr/Connr.Process/Statistics.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
class 

Statistics 
{ 
public 

int 
	ProcessId 
{ 
get 
; 
set  #
;# $
}% &
public		 

DateTimeOffset		 
	StartedAt		 #
{		$ %
get		& )
;		) *
set		+ .
;		. /
}		0 1
public 

DateTimeOffset 
	StoppedAt #
{$ %
get& )
;) *
set+ .
;. /
}0 1
public 

long 

TotalLines 
=> 
OutputLines )
+* +

ErrorLines, 6
;6 7
public 

long 

ErrorLines 
{ 
get  
;  !
private" )
set* -
;- .
}/ 0
public 

long 
OutputLines 
{ 
get !
;! "
private# *
set+ .
;. /
}0 1
public 

DateTimeOffset 
LastErrorAt %
{& '
get( +
;+ ,
private- 4
set5 8
;8 9
}: ;
public 

DateTimeOffset 
LastOutputAt &
{' (
get) ,
;, -
private. 5
set6 9
;9 :
}; <
private 
readonly 
ConcurrentQueue $
<$ %
Line% )
>) *
_mostRecentLines+ ;
=< =
new> A
(A B
)B C
;C D
private 
readonly 
SemaphoreSlim "

_semaphore# -
=. /
new0 3
SemaphoreSlim4 A
(A B
$numB C
,C D
$numE F
)F G
;G H
internal 
Line 
AddToRecentLines "
(" #
string# )
output* 0
,0 1
bool2 6
isStandardOutput7 G
)G H
{ 
try 
{ 	

_semaphore 
. 
Wait 
( 
) 
; 
if   
(   
isStandardOutput    
)    !
{!! 
LastOutputAt"" 
="" 
DateTimeOffset"" -
.""- .
Now"". 1
;""1 2
OutputLines## 
++## 
;## 
}$$ 
else%% 
{&& 
LastErrorAt'' 
='' 
DateTimeOffset'' ,
.'', -
Now''- 0
;''0 1

ErrorLines(( 
++(( 
;(( 
})) 
var** 
line** 
=** 
new** 
Line** 
(**  
)**  !
{**" #
Number**$ *
=**+ ,

TotalLines**- 7
,**7 8
Output**9 ?
=**@ A
output**B H
,**H I
IsStandardOutput**J Z
=**[ \
isStandardOutput**] m
}**n o
;**o p
_mostRecentLines,, 
.,, 
Enqueue,, $
(,,$ %
line,,% )
),,) *
;,,* +
if-- 
(-- 
_mostRecentLines--  
.--  !
Count--! &
>--' (
$num--) +
)--+ ,
_mostRecentLines--- =
.--= >

TryDequeue--> H
(--H I
out--I L
_--M N
)--N O
;--O P
return// 
line// 
;// 
}00 	
finally11 
{22 	

_semaphore33 
.33 
Release33 
(33 
)33  
;33  !
}44 	
}55 
public77 

IReadOnlyList77 
<77 
Line77 
>77 
GetMostRecentLines77 1
(771 2
)772 3
{88 
try99 
{:: 	

_semaphore;; 
.;; 
Wait;; 
(;; 
);; 
;;; 
return<< 
_mostRecentLines<< #
.<<# $
ToList<<$ *
(<<* +
)<<+ ,
.<<, -

AsReadOnly<<- 7
(<<7 8
)<<8 9
;<<9 :
}== 	
finally>> 
{?? 	

_semaphore@@ 
.@@ 
Release@@ 
(@@ 
)@@  
;@@  !
}AA 	
}BB 
}CC ‡
2/Users/jeff/projects/connr/Connr.Process/Tokens.cs
	namespace 	
Connr
 
. 
Process 
; 
public 
class 
Tokens 
: 
IDisposable !
{ 
public 

Tokens 
( 

Parameters 

parameters '
)' (
{ 
StopTokenSource 
= 
new #
CancellationTokenSource 5
(5 6
)6 7
;7 8
if 

( 

parameters 
. 
StopAfterSeconds '
>( )
$num* +
)+ ,
StopTokenSource		 
.		 
CancelAfter		 '
(		' (
TimeSpan		( 0
.		0 1
FromSeconds		1 <
(		< =

parameters		= G
.		G H
StopAfterSeconds		H X
)		X Y
)		Y Z
;		Z [
}

 
public 
#
CancellationTokenSource "
StopTokenSource# 2
{3 4
get5 8
;8 9
}: ;
=< =
new> A
(A B
)B C
;C D
public 
#
CancellationTokenSource "
KillTokenSource# 2
{3 4
get5 8
;8 9
}: ;
=< =
new> A
(A B
)B C
;C D
public 

void 
Dispose 
( 
) 
{ 
StopTokenSource 
? 
. 
Dispose  
(  !
)! "
;" #
KillTokenSource 
? 
. 
Dispose  
(  !
)! "
;" #
} 
} 